# SRD Addendum: AgentProfile Fuzzing Engine and Mapper

## 1. Introduction and Objectives

This addendum defines the requirements for integrating a custom, non-destructive fuzzing engine directly with the structured output of the `Agent Interrogator` CLI tool (the `AgentProfile`). The objective is to transition from attack surface *discovery* to systematic, parameter-aware security *validation* against the underlying Model Context Protocol (MCP) server functions.

The fuzzing module must operate strictly as a component of an authorized penetration testing suite, prioritizing the identification of validation flaws, logic errors, and "Excessive Agency" vulnerabilities over destructive operations.

## 2. Input Data Structure Specification

The Fuzzing Engine Mapper must consume the existing `AgentProfile` Python object structure (or its normalized file representation) generated by the `Agent Interrogator`.

### 2.1 AgentProfile Schema Elements

The mapper must be capable of iterating and extracting data from the following fields for every discovered tool:

| Element | Description | Criticality for Fuzzing |
| :--- | :--- | :--- |
| `capability.name` | High-level task category (Context) | Low (Context only) |
| `function.name` | The exact invokable function (e.g., `gmail_delete_email`) | **High (Execution Target)** |
| `function.return_type` | Expected data type of the response (e.g., `array of transaction objects`) | Medium (Response validation) |
| `function.parameters` | A list of parameter objects. | **High (Payload Blueprint)** |

### 2.2 Function Parameter Schema

The fuzzing logic must be driven by the following elements within each `function.parameter` object:

| Parameter Element | Description | Fuzzing Requirement |
| :--- | :--- | :--- |
| `name` | Parameter name (e.g., `userId`, `query`, `email_id`) | **Required for Input Mapping** |
| `type` | Expected data type (`string`, `integer`, `boolean`, `list`, `object`) | **Required for Type Fuzzing** |
| `required` | Boolean flag indicating if the field is mandatory | Required for Omission Testing |
| `default` | Default value (if available) | Required for Baseline/Non-fuzzed testing |

## 3. Functional Requirements (FR)

### FR-1: Fuzzing Target Identification

The mapper component shall parse the `AgentProfile` and generate a definitive list of unique Fuzzing Target Objects. Each object shall contain the `function.name` and its complete input schema (list of parameter names, types, and requirements).

### FR-2: Parameter-Aware Payload Generation

For each identified Fuzzing Target Object, the Fuzzing Module shall generate a battery of test payloads based on the declared parameter type, focusing on non-destructive techniques.

| Parameter Type | Fuzzing Strategy | Test Cases (Minimum) |
| :--- | :--- | :--- |
| `string` | **Injection & Boundary Testing** | Empty string, extremely long string (boundary), common XSS/SQL/Command injection canary strings, JSON/XML structure payloads, path traversal payloads (`../..`). |
| `integer` / `number` | **Boundary & Type Confusion** | Zero (0), negative values (-1), MAX/MIN integer limits, floating-point numbers where integers are expected (type confusion), non-numeric strings (type confusion). |
| `boolean` | **Logic Flaws** | True, False, "1", "0", "tRuE" (case sensitivity). |
| `list` / `array` | **Boundary & Enumeration** | Empty array, array with single element, array with excessive elements, array with mixed/invalid types. |
| All Types | **Authentication/Authorization** | Inputs specifically targeting IDOR (Insecure Direct Object Reference) by iterating sequential or common IDs if the parameter name suggests user context (e.g., `userId`, `accountId`). |

### FR-3: MCP Function Invocation

The Fuzzing Module must use the connection parameters established by the primary CLI script (URL, headers, proxy configuration, authentication tokens) to communicate with the target MCP server.

1.  **Serialization:** The module shall serialize the generated fuzz payloads (FR-2) into the correct structure required by the MCP server for a tool call (typically a JSON object detailing the function name and arguments).
2.  **Execution:** The module shall execute the MCP function call, transmitting the fuzzed input to the target server.

### FR-4: Response Analysis and Logging

Upon receiving a response from the MCP server, the Fuzzing Module must log the results for security review.

1.  **Status Capture:** Capture the raw HTTP status code from the underlying MCP connection (e.g., 200, 400, 401, 500).
2.  **Output Capture:** Log the full agent or server response body.
3.  **Vulnerability Detection:** Flag responses that indicate success (2xx) or unexpected behavior (5xx, 4xx) when using malformed or injected input. Special attention must be paid to responses that reveal internal function details or stack traces.

### FR-5: Recursive Interrogation Preparation (Future Integration)

The module should be architected such that its output format can eventually be used as input for further recursive analysis, supporting future research requirements for mapping complex Multi-Agent Systems (MAS) where one discovered tool is itself another agent (A2A or via MCP).

## 4. Non-Functional Requirements (NFR)

### NFR-1: Operational Safety (Crucial for Professional Engagements)

The Fuzzing Module shall be strictly non-destructive by default.

1.  **Payload Filtering:** Fuzzing inputs targeting functions with high-risk names (`delete`, `remove`, `modify`, `execute`, `shutdown`, `create_user`) shall use **canary data** or **safe test values** (e.g., using "TEST\_FUZZ\_XYZ" strings instead of executing actual dangerous operations).
2.  **No Automated Privilege Escalation:** The fuzzer must assume the authentication context provided by the main CLI script (`MCP_AUTH_TOKEN`) is the maximum authorized privilege and must not attempt to automatically generate or test administrator-level credentials.

### NFR-2: Robustness and Inconsistency Handling

1.  **Ambiguous Typing:** The module must account for the real-world ambiguity noted in the research, where a parameter declared as a `string` (e.g., `userId: string`) may expect numerical data passed as a string (`"123"`). The fuzzer must test both string-based injection and numeric boundary cases for such parameters to ensure coverage.
2.  **Rate Limit Adherence:** The Fuzzing Module execution loop must integrate seamlessly with the existing `--rate-limit-target` configuration defined in the primary CLI, adding the specified delay (e.g., 3 seconds) between successive MCP function calls to avoid detection or throttling.

### NFR-3: Performance and Efficiency

The fuzzer shall rely exclusively on the single, structured `AgentProfile` output file for target definitions. The Fuzzing Module must **not** re-initialize or rerun the iterative discovery process of the `Agent Interrogator` during its execution phase, as this would consume excessive LLM resources and violate the efficiency goals of using the structured profile.

## 5. Deliverables

1.  **`fuzzing_module.py`:** Python module containing the core logic for mapping, payload generation, and MCP invocation.
2.  **`agent_fuzzer_cli_addon.py`:** Integration wrapper allowing the existing CLI tool to invoke the fuzzing module against a pre-existing or newly generated `AgentProfile` file.
3.  **Payload Library:** A dedicated, modular set of non-destructive fuzz strings, number lists, and structure templates tailored for common AI agent security flaw classes (injection, boundary, logic errors).